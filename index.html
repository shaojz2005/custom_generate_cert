<!--
  证书生成器 - Certificate Generator
  
  Copyright (c) 2024 Aeven
  
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  
  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.
  
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量证书生成器</title>
    <link rel="stylesheet" href="lib/tailwind.min.css">
    <script src="lib/vue.global.js"></script>
    <script src="lib/xlsx.full.min.js"></script>
    <script src="lib/jszip.min.js"></script>
    <script src="lib/FileSaver.min.js"></script>
    <style>
        .canvas-container {
            position: relative;
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
        }
        .text-element {
            position: absolute;
            cursor: move;
            border: 1px dashed #d1d5db;
            padding: 0; /* 移除内边距，让文本更精确对齐 */
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            background-color: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            box-sizing: border-box;
            line-height: 1.2; /* 与Canvas绘制保持一致的行高 */
            font-family: Arial, sans-serif; /* 确保字体与Canvas一致 */
        }
        .text-element:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .text-element.selected {
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            border-width: 2px;
        }
        .dragging {
            z-index: 1000;
        }
        
        /* 拖拽调整尺寸的手柄样式 */
        .resize-handles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .resize-handle {
            position: absolute;
            background-color: #007bff;
            border: 1px solid #fff;
            pointer-events: auto;
            z-index: 10;
        }

        .resize-handle-se {
            width: 8px;
            height: 8px;
            bottom: -4px;
            right: -4px;
            cursor: se-resize;
        }

        .resize-handle-e {
            width: 6px;
            height: 20px;
            top: 50%;
            right: -3px;
            transform: translateY(-50%);
            cursor: e-resize;
        }

        .resize-handle-s {
            width: 20px;
            height: 6px;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            cursor: s-resize;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">批量证书生成器</h1>
            
            <!-- 功能介绍区 -->
            <div class="max-w-4xl mx-auto mb-8">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 text-center border border-blue-100">
                    <p class="text-lg text-gray-700 mb-3">
                        一个专业的证书批量生成工具，支持Excel数据导入、可视化设计和文本精确排版
                    </p>
                    <p class="text-gray-600 mb-4">
                        支持水平垂直对齐、文本框尺寸调整、智能换行等专业排版功能，让您轻松制作精美证书
                    </p>
                    <div class="flex justify-center space-x-4">
                        <a href="example.html" target="_blank" 
                           class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            查看使用示例
                        </a>
                        <a href="README.md" target="_blank" 
                           class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            功能说明
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- 步骤指示器 -->
            <div class="flex justify-center mb-8">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium"
                             :class="step >= 1 ? 'bg-blue-500' : 'bg-gray-300'">1</div>
                        <span class="ml-2 text-sm font-medium text-gray-700">上传文件</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium"
                             :class="step >= 2 ? 'bg-blue-500' : 'bg-gray-300'">2</div>
                        <span class="ml-2 text-sm font-medium text-gray-700">设计证书</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium"
                             :class="step >= 3 ? 'bg-blue-500' : 'bg-gray-300'">3</div>
                        <span class="ml-2 text-sm font-medium text-gray-700">生成下载</span>
                    </div>
                </div>
            </div>

            <!-- 步骤1: 文件上传 -->
            <div v-if="step === 1" class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">1. 上传Excel文件</h2>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" @change="handleExcelUpload" accept=".xlsx,.xls" class="hidden" ref="excelInput">
                        <button @click="$refs.excelInput.click()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            选择Excel文件
                        </button>
                        <p class="text-gray-500 mt-2">支持 .xlsx 和 .xls 格式</p>
                        <div v-if="excelData.length > 0" class="mt-4 text-left">
                            <p class="text-green-600 font-medium">✓ 已上传文件，共 {{ excelData.length }} 行数据</p>
                            <p class="text-sm text-gray-600 mt-1">字段: {{ excelHeaders.join(', ') }}</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">2. 上传证书背景图</h2>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" @change="handleImageUpload" accept="image/*" class="hidden" ref="imageInput">
                        <button @click="$refs.imageInput.click()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                            选择背景图片
                        </button>
                        <p class="text-gray-500 mt-2">支持 JPG、PNG 等图片格式</p>
                        <div v-if="backgroundImage" class="mt-4">
                            <p class="text-green-600 font-medium">✓ 已上传背景图</p>
                            <img :src="backgroundImage" class="max-w-xs mx-auto mt-2 rounded border">
                        </div>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <button @click="nextStep" :disabled="!canProceedToStep2" 
                            class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white px-6 py-2 rounded-lg">
                        下一步：设计证书
                    </button>
                </div>
            </div>

            <!-- 步骤2: 证书设计 -->
            <div v-if="step === 2" class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- 左侧工具栏 -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-lg shadow-md p-4 sticky top-4">
                            <h3 class="font-semibold mb-4">工具栏</h3>
                            
                            <div class="mb-4">
                                <button @click="addTextElement" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg mb-2">
                                    添加文本
                                </button>
                            </div>

                            <div class="mb-4">
                                <h4 class="font-medium mb-2">可用字段</h4>
                                <p class="text-xs text-gray-500 mb-2">点击字段名自动创建文本并插入变量</p>
                                <div class="space-y-1">
                                    <div v-for="header in excelHeaders" :key="header" 
                                         class="text-sm bg-gray-100 px-2 py-1 rounded cursor-pointer hover:bg-gray-200"
                                         @click="insertVariable(header)">
                                        {{ header }}
                                    </div>
                                </div>
                            </div>

                            <div v-if="selectedElement" class="border-t pt-4">
                                <h4 class="font-medium mb-2">文本属性</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">字体大小</label>
                                        <input v-model.number="selectedElement.fontSize" type="number" min="8" max="100"
                                               class="w-full border rounded px-2 py-1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">颜色</label>
                                        <input v-model="selectedElement.color" type="color"
                                               class="w-full border rounded px-2 py-1 h-8">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">字体粗细</label>
                                        <select v-model="selectedElement.fontWeight" class="w-full border rounded px-2 py-1">
                                            <option value="normal">正常</option>
                                            <option value="bold">粗体</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">水平对齐</label>
                                        <select v-model="selectedElement.textAlign" class="w-full border rounded px-2 py-1">
                                            <option value="left">左对齐</option>
                                            <option value="center">居中对齐</option>
                                            <option value="right">右对齐</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">垂直对齐</label>
                                        <select v-model="selectedElement.verticalAlign" class="w-full border rounded px-2 py-1">
                                            <option value="top">顶部对齐</option>
                                            <option value="middle">居中对齐</option>
                                            <option value="bottom">底部对齐</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">宽度</label>
                                            <input v-model.number="selectedElement.width" type="number" min="50" max="800"
                                                   class="w-full border rounded px-2 py-1">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">高度</label>
                                            <input v-model.number="selectedElement.height" type="number" min="20" max="400"
                                                   class="w-full border rounded px-2 py-1">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">文本内容</label>
                                        <textarea v-model="selectedElement.text" 
                                                  class="w-full border rounded px-2 py-1 h-20 text-sm"></textarea>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="updateElementSize(selectedElement)" 
                                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                            自适应尺寸
                                        </button>
                                        <button @click="deleteSelectedElement" 
                                                class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                            删除元素
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 中间画布区域 -->
                    <div class="lg:col-span-3">
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <h3 class="font-semibold mb-4">证书设计画布</h3>
                            <div class="canvas-container mx-auto" 
                                 :style="{ width: canvasWidth + 'px', height: canvasHeight + 'px', backgroundImage: `url(${backgroundImage})`, backgroundSize: canvasWidth + 'px ' + canvasHeight + 'px', backgroundRepeat: 'no-repeat', backgroundPosition: '0 0' }"
                                 @click="deselectElement">
                                <div v-for="(element, index) in textElements" :key="element.id"
                                     class="text-element"
                                     :class="{ selected: selectedElement === element }"
                                     :style="{ 
                                         left: element.x + 'px', 
                                         top: element.y + 'px',
                                         width: (element.width || 200) + 'px',
                                         height: (element.height || 40) + 'px',
                                         fontSize: element.fontSize + 'px',
                                         color: element.color,
                                         fontWeight: element.fontWeight,
                                         textAlign: element.textAlign || 'left',
                                         alignItems: getVerticalAlignClass(element.verticalAlign),
                                         justifyContent: getHorizontalAlignClass(element.textAlign)
                                     }"
                                     @click.stop="selectElement(element)"
                                     @mousedown="startDrag(element, $event)">
                                    {{ element.text }}
                                    
                                    <!-- 拖拽调整尺寸的手柄 -->
                                    <div v-if="selectedElement === element" class="resize-handles">
                                        <!-- 右下角拖拽手柄 -->
                                        <div class="resize-handle resize-handle-se" 
                                             @mousedown.stop="startResize(element, 'se', $event)"></div>
                                        <!-- 右边拖拽手柄 -->
                                        <div class="resize-handle resize-handle-e" 
                                             @mousedown.stop="startResize(element, 'e', $event)"></div>
                                        <!-- 下边拖拽手柄 -->
                                        <div class="resize-handle resize-handle-s" 
                                             @mousedown.stop="startResize(element, 's', $event)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-6 space-x-4">
                            <button @click="prevStep" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                                上一步
                            </button>
                            <button @click="previewCertificate" :disabled="excelData.length === 0" 
                                    class="bg-purple-500 hover:bg-purple-600 disabled:bg-gray-300 text-white px-6 py-2 rounded-lg">
                                预览证书
                            </button>
                            <button @click="nextStep" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                                下一步：生成证书
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 步骤3: 生成下载 -->
            <div v-if="step === 3" class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">3. 生成证书</h2>
                    
                    <div class="text-center mb-6">
                        <button @click="generateCertificates" :disabled="isGenerating"
                                class="bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white px-8 py-3 rounded-lg text-lg font-medium">
                            <span v-if="!isGenerating">生成所有证书</span>
                            <span v-else>生成中... {{ generationProgress }}%</span>
                        </button>
                    </div>

                    <div v-if="isGenerating" class="mb-6">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" 
                                 :style="{ width: generationProgress + '%' }"></div>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2">
                            正在生成第 {{ currentGeneratingIndex + 1 }} / {{ excelData.length }} 张证书
                        </p>
                    </div>

                    <div class="text-center space-x-4">
                        <button @click="prevStep" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            上一步
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 预览模态框 -->
        <div v-if="showPreview" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click="closePreview">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl max-h-[90vh] overflow-auto" @click.stop>
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">证书预览</h3>
                        <button @click="closePreview" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="text-center mb-4">
                        <p class="text-sm text-gray-600">使用第一条记录数据预览：{{ previewDataInfo }}</p>
                    </div>
                    <div class="flex justify-center">
                        <canvas ref="previewCanvas" class="border border-gray-300 max-w-full max-h-[60vh]"></canvas>
                    </div>
                    <div class="text-center mt-4">
                        <button @click="closePreview" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            关闭预览
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>